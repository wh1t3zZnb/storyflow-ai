# 分镜工具 - 开发文档

## 项目概述
专业的分镜设计工具,支持从剧本到角色设定再到分镜生成的完整工作流。

## 技术栈
- **前端框架**: React 18
- **开发工具**: Vite
- **UI库**: Lucide React (图标)
- **AI服务**: OpenRouter API (Gemini 2.5 Flash Image)

## 项目结构

```
分镜/
├── src/
│   ├── components/          # 组件目录
│   │   ├── ScriptPane.jsx          # 剧本编辑面板
│   │   ├── CharacterPane.jsx       # 角色管理面板
│   │   ├── StoryboardPane.jsx      # 分镜展示面板
│   │   ├── ProjectSetupModal.jsx   # 项目设置弹窗
│   │   └── SettingsModal.jsx       # API设置弹窗
│   │
│   ├── utils/               # 工具函数
│   │   ├── llm.js                  # LLM接口封装(剧本分析、角色提取)
│   │   ├── imageGeneration.js      # 图片生成API封装
│   │   ├── apiConfig.js            # API配置管理
│   │   └── mockImage.js            # Mock图片生成
│   │
│   ├── App.jsx              # 主应用组件
│   ├── index.css            # 全局样式
│   └── main.jsx             # 入口文件
│
├── test/                    # 测试脚本
│   ├── test_storyboard_generation.py  # 分镜生成测试
│   └── test_nanobanana.py             # API连接测试
│
└── docs/                    # 文档目录
    ├── 图片生成技术方案.md
    └── 图片生成API集成方案.md
```

## 核心功能模块

### 1. 剧本管理 (ScriptPane)
- ✅ 剧本文本编辑
- ✅ 剧本上传 (`.txt`文件)
- ✅ 随机模板生成
- ✅ AI智能角色提取

**流程**:
1. 用户输入/上传剧本
2. 点击"智能拆分分镜"
3. 调用`extractRoles`API提取角色
4. 自动跳转到"角色"标签页

### 2. 角色管理 (CharacterPane)
- ✅ 角色列表展示(卡片视图)
- ✅ 新建/编辑角色
- ✅ **AI生成角色参考图** ⭐ (新增)
- ✅ 手动上传参考图
- ✅ 角色信息编辑(名称、年龄、性别、特征、背景)

**新功能: AI生成角色参考图**
- 文件: `src/utils/imageGeneration.js`
- API: `generateCharacterImage(character)`
- 输入: 角色名、描述、年龄、性别、特征
- 输出: Base64编码的图片数据

**使用方法**:
1. 填写角色基本信息(至少要有名称)
2. 点击"生成预览图"按钮
3. 等待API返回(显示"生成中..."状态)
4. 图片自动填充到预览区

**流程**:
1. 从剧本自动提取角色 OR 手动添加
2. 编辑角色详细信息
3. **生成或上传参考图**
4. 点击"下一步:拆分分镜"
5. 自动跳转到"分镜"标签页

### 3. 分镜管理 (StoryboardPane)
- ✅ 列表视图/卡片视图切换
- ✅ 分镜信息编辑(场号、景别、角度、运镜、画面、台词、时长)
- ✅ 单张分镜预览图生成(Mock)
- ✅ 批量生成预览图(Mock)
- ✅ 手动上传预览图
- ⏳ **AI生成分镜图**(待实现)

**流程**:
1. AI根据剧本和角色生成分镜列表
2. 用户编辑分镜详情
3. 生成/上传预览图
4. 导出或继续编辑

## API集成

### 图片生成API
- **服务商**: OpenRouter
- **模型**: `google/gemini-2.5-flash-image`
- **Base URL**: `https://openrouter.ai/api/v1/chat/completions`

#### 1. 角色参考图生成

**函数**: `generateCharacterImage(character)`

**请求格式**:
```javascript
{
  model: "google/gemini-2.5-flash-image",
  messages: [
    {
      role: "system",
      content: "你是专业的角色设计师,擅长创作一致的角色形象。"
    },
    {
      role: "user",
      content: "请生成角色参考图: [name]\n[description]..."
    }
  ]
}
```

**提示词构建策略**:
- 基础信息: 角色名、性别、年龄
- 外观描述: desc字段
- 特征标签: traits字段
- 固定要求: 写实摄影风格、正面或3/4侧面、清晰面部

**响应格式**:
```javascript
{
  choices: [{
    message: {
      images: [{
        type: "image_url",
        image_url: {
          url: "data:image/png;base64,iVBORw0KGgo..."
        }
      }]
    }
  }]
}
```

#### 2. 分镜图生成 (待实现)

**函数**: `generateStoryboardImage(frame, characters, globalStyle)`

**特点**:
- 支持角色参考图传入
- 根据景别、角度自动调整构图
- 保持角色外观一致性

## 数据结构

### 角色对象 (Character)
```javascript
{
  id: string,              // 唯一ID
  name: string,            // 角色名
  desc: string,            // 外观描述
  age: string,             // 年龄
  gender: string,          // 性别
  traits: string,          // 特征标签
  backstory: string,       // 背景故事
  styleTags: string[],     // 风格标签数组
  imageUrl: string,        // 参考图URL(Base64或Blob URL)
  referenceImages: string[], // 参考图数组
  avatarColor: string      // 头像背景色
}
```

### 分镜对象 (Frame)
```javascript
{
  id: string,              // 唯一ID
  scene: string,           // 场号
  shot: string,            // 景别(特写/中景/全景)
  character: string,       // 角色名(逗号分隔)
  cameraAngle: string,     // 角度(平视/俯视/仰视)
  cameraMovement: string,  // 运镜(固定/推进/拉远)
  content: string,         // 画面描述
  dialogue: string,        // 台词/音效
  duration: number,        // 时长(秒)
  imageUrl: string         // 预览图URL
}
```

## 工作流程

```
剧本编辑 → AI提取角色 → 角色设定 → AI拆分分镜 → 分镜编辑 → 导出
   ↓           ↓            ↓          ↓           ↓         ↓
 手动输入   自动/手动    生成参考图   自动生成   编辑/生成图  PDF/图片
```

## 开发进度

### ✅ 已完成
- [x] 基础UI框架
- [x] 剧本编辑功能
- [x] 角色管理功能
- [x] 分镜展示功能
- [x] AI角色提取
- [x] AI分镜拆分
- [x] API配置管理
- [x] **图片生成API封装**
- [x] **角色参考图AI生成功能**

### ⏳ 进行中
- [ ] 分镜图AI生成功能
- [ ] 批量生成优化
- [ ] 错误处理完善

### 📋 待开发
- [ ] 导出功能(PDF/图片)
- [ ] 本地存储/云端同步
- [ ] 历史记录管理
- [ ] 更多风格模板
- [ ] 批量编辑功能

## 最近更新

### 2025-11-22
- ✅ 创建图片生成API封装(`src/utils/imageGeneration.js`)
- ✅ 实现`generateCharacterImage()`函数
- ✅ 实现`generateStoryboardImage()`函数(待集成)
- ✅ 在角色编辑模态框中集成AI生成功能
- ✅ 添加生成状态显示("生成中...")
- ✅ 添加错误提示和验证

**技术细节**:
- Base64图片直接存储,无需额外存储服务
- 使用async/await进行异步处理
- 添加loading状态防止重复点击
- 提示词优化:简洁、结构化、符合AI理解

## 运行项目

### 开发环境
```bash
npm run dev
```

### 测试API
```bash
# 测试角色图片生成
python test/test_storyboard_generation.py
```

## 注意事项

1. **API限制**
   - 图片生成耗时较长(15-30秒)
   - 需要有效的OpenRouter API Key
   - 注意并发调用限制

2. **图片数据**
   - Base64编码会增大数据体积
   - 建议后续考虑云存储方案
   - localStorage有大小限制(~5MB)

3. **提示词优化**
   - 避免添加视频相关参数(运镜、时长)
   - 保持描述简洁清晰
   - 重视角色参考图质量

## 贡献指南

添加新功能时,请遵循:
1. 模块化开发,每个功能一个文件
2. 保持代码解耦
3. 更新此开发文档
4. 添加必要的错误处理

---

**最后更新**: 2025-11-22
**版本**: v1.2.0
