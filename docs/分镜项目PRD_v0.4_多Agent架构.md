# 文献速读神器/AI智能分镜 PRD (v0.4)

| 文档版本 | 修订日期 | 修改描述 | 作者 |
| :--- | :--- | :--- | :--- |
| v0.1 | 2025-12-01 | 初始草稿 | AI Assistant |
| v0.2 | 2025-12-01 | 移除剧本生成，集成图片/导出 | AI Assistant |
| v0.3 | 2025-12-01 | 重构为多Agent架构 | AI Assistant |
| v0.4 | 2025-12-01 | 调整目录结构，补充Prompt细节 | AI Assistant |

---

## 1. 项目背景
随着短视频、微短剧及影视行业的爆发式增长，创作者对内容生产效率的要求日益提高。传统的分镜制作流程耗时长、成本高，且严重依赖专业画师。虽然市面上已有部分AI工具，但大多停留在单点功能（如单纯的文生图），缺乏对影视工作流的深度整合，难以保证角色一致性、镜头语言的专业性以及最终产出的可用性。本项目旨在打造一个**全流程AI智能分镜系统**，通过多Agent协作，将剧本直接转化为可视化的分镜脚本、角色设计、视频预览及配音合成，极大地降低创作门槛，提升生产效率。

## 2. 目标用户
*   **影视导演/制片人**：需要快速验证剧本可行性，制作Pitch Deck（提案演示）。
*   **短视频/微短剧创作者**：追求高频更新，需要低成本、快速产出分镜和视频预演。
*   **广告创意代理商**：需要向客户快速展示视觉创意方案。
*   **独立动画师/编剧**：个人创作者，缺乏美术功底但有好的故事创意。

## 3. 核心痛点
1.  **可视化成本高**：聘请专业分镜师价格昂贵（单页数百至上千元），且沟通修改成本高。
2.  **角色一致性差**：通用文生图模型难以在不同分镜中保持角色形象（脸部、着装）的统一。
3.  **镜头语言缺失**：普通AI工具不懂景别（特写/全景）、运镜（推拉摇移）和视听语言，生成的画面缺乏叙事感。
4.  **工作流割裂**：剧本拆解、角色设计、分镜绘制、视频生成通常需要在不同软件间切换，数据不互通。
5.  **修改迭代难**：剧本一改，后续所有分镜、视频都需要推倒重来，缺乏联动更新机制。

## 4. 项目目标
1.  **全流程自动化**：实现从“剧本”到“分镜表”再到“动态视频预览”的一站式自动化生成。
2.  **角色一致性**：通过专门的角色Agent和一致性控制技术（如FaceID/LoRA/Seed控制），确保同一角色在不同镜头中形象稳定。
3.  **专业级镜头语言**：内置导演思维的Prompt工程，自动识别并应用正确的景别、角度和运镜。
4.  **多模态输出**：支持导出Excel/PDF分镜表、合成带有配音和动态效果的Animatic（动态分镜）。
5.  **企业级架构**：采用多Agent协作架构，各司其职，便于后续扩展和模型替换。

## 5. 核心功能/流程 (多Agent架构)

本项目采用 **多Agent协作 (Multi-Agent Collaboration)** 架构，由一个核心编辑器调度5个专业Agent完成任务。

### 5.1 系统架构图

```mermaid
graph TD
    User[用户/总导演] --> Editor[核心编辑器 (The Studio)]
    
    subgraph Agents [虚拟制作团队]
        ScriptAgent[剧本 Agent]
        CharAgent[角色 Agent]
        StoryAgent[分镜 Agent]
        ImageAgent[绘图 Agent]
        VideoAgent[视频/配音 Agent]
    end
    
    Editor <--> ScriptAgent
    Editor <--> CharAgent
    Editor <--> StoryAgent
    Editor <--> ImageAgent
    Editor <--> VideoAgent
    
    ScriptAgent -->|提取角色/大纲| CharAgent
    ScriptAgent -->|剧本拆解| StoryAgent
    CharAgent -->|角色资产/Prompt| ImageAgent
    StoryAgent -->|分镜描述| ImageAgent
    ImageAgent -->|分镜图| VideoAgent
    ScriptAgent -->|台词| VideoAgent
```

### 5.2 核心流程详解

1.  **核心编辑器 (The Studio)**
    *   **功能**：用户交互的主界面，负责任务分发、状态管理、人工干预（编辑/修正）及最终合成。
    *   **输入**：用户上传的剧本文件或手动输入的文本。
    *   **输出**：完整的可视化分镜项目。

2.  **剧本 Agent (Script Analysis Agent)**
    *   **职责**：理解剧本，提取关键信息。
    *   **核心功能**：
        *   **角色提取**：分析剧本中的人物，提取姓名、年龄、性别、外貌描写、性格特征。
        *   **场景拆解**：识别场景变化，将连续文本拆解为独立的“场”。
    *   **当前进度**：已实现角色提取逻辑。

3.  **角色 Agent (Character Design Agent)**
    *   **职责**：管理和设计角色形象，维护一致性。
    *   **核心功能**：
        *   **形象设计**：根据文本描述生成详细的角色外观Prompt。
        *   **一致性管理**：存储角色的Seed、FaceID或特征向量，供绘图Agent调用。
    *   **当前进度**：已实现基础Prompt构建和图片生成触发。

4.  **分镜 Agent (Storyboard Director Agent)**
    *   **职责**：将剧本转化为镜头语言。
    *   **核心功能**：
        *   **自动分镜**：将一场戏拆分为多个镜头（Frame）。
        *   **镜头参数**：自动判定景别（Shot）、角度（Angle）、运镜（Movement）。
        *   **画面描述**：生成适合绘图模型的画面Prompt（去除文学修饰，转为视觉描述）。
    *   **当前进度**：已实现基于LLM的自动拆分逻辑。

5.  **绘图 Agent (Visual Artist Agent)**
    *   **职责**：将文字描述转化为高质量图片。
    *   **核心功能**：
        *   **文生图**：调用Gemini/SD/Midjourney生成画面。
        *   **风格控制**：统一画风（如写实、二次元、黑白线稿）。
    *   **当前进度**：已集成Gemini Image模型，支持风格预设。

6.  **视频/配音 Agent (Post-Production Agent)**
    *   **职责**：让分镜动起来。
    *   **核心功能**：
        *   **图生视频**：将静态分镜图转化为4s左右的动态视频（Runway/Kling）。
        *   **TTS配音**：将台词转化为语音（11Labs/EdgeTTS）。
    *   **当前进度**：规划中，尚未实装。

## 6. 提示词结构 (Prompt Structure)

基于当前代码实现，核心Prompt结构如下（原文引用）：

### 6.1 角色提取 (Script Agent)
*   **System Prompt (Code: `src/utils/llm.js`)**:
    ```text
    你是专业的剧本分析助手。从剧本中提取所有角色信息。

    【输出格式】
    只返回JSON对象，格式: {"roles": Character[]}

    【Character对象字段】（所有字段都必须填写）
    - name: string - 角色名称
    - age: string - 年龄或年龄段(例如"25"、"30岁左右"、"中年")
    - gender: string - 性别("男"、"女"或"其他")
    - desc: string - 外观描述(发型、着装、体型等可视化特征，30-100字)
    - traits: string - 性格特征标签(例如"冷酷,敏捷,果断")
    - backstory: string - 背景故事(简要说明角色背景，20-50字)
    - styleTags: string[] - 风格标签数组(例如["写实","黑色电影"])
    - nationality: string - 国籍(根据剧本判断；若剧本未明确说明且该角色确实存在，则默认填"中国")

    【提取要求】
    1. 从剧本中识别所有出现的角色
    2. 根据剧本内容推断角色信息（年龄、性别、外貌等）
    3. desc字段必须是外观描述，不要包含性格和背景
    4. 如果剧本中某些信息不明确，根据上下文合理推断
    5. styleTags根据剧本整体风格判断
    6. 所有字段都不能为空，必须有内容；国籍字段仅在存在角色时必须填写，若剧本未明确国籍则填"中国"
    ```
*   **User Prompt**: `请从以下剧本中提取所有角色信息:\n\n${script}`

### 6.2 分镜拆分 (Storyboard Agent)
*   **System Prompt (Code: `src/utils/llm.js`)**:
    ```text
    你是专业的分镜师。根据剧本拆分出详细的分镜列表。

    【输出格式】
    只返回JSON对象，格式: {"frames": StoryboardFrame[]}

    【StoryboardFrame对象字段】（所有字段都必须合理填写）
    - scene: string - 场号(从1开始递增)
    - shot: string - 景别（常用选项示例）："特写", "近景", "中景", "全景", "远景"
    - character: string - 角色名(多个用逗号分隔,无角色留空)，必须使用提供的角色名
    - cameraAngle: string - 机位角度（常用选项示例）："平视", "俯视", "仰视", "倾斜"
    - cameraMovement: string - 运镜方式（常用选项示例）："固定", "推进", "拉远", "跟随", "摇镜", "升降"
    - content: string - 画面描述(描述画面中的视觉元素、光线、氛围等，不要包含运镜和景别信息)
    - dialogue: string - 台词或音效(如果没有台词,描述环境音效，如"雨声"、"脚步声"等)
    - duration: number - 时长(秒)，按剧情自然节奏计算，单镜不超过10秒

    【拆分要求】
    严格依据剧本，不进行扩写；不得新增事件、角色、地点或时间变化，不得改变叙事顺序与因果关系。
    流程：
    ① 提取场景/情绪节拍；② 合并同地点的连续动作链为单镜；③ 为每镜写完整画面；④ 在非最后一镜结尾写承接语素；⑤ 计算每镜时长≤10秒。
    1. 连贯优先：同一地点连续动作链一镜讲清；弱动作或物件细节吸收进相邻镜头。
    2. 拆分触发：仅在空间明确变化、时间跳转、信息或情绪显著转折时拆分；连续微动作用运镜表达而非切镜。
    3. 景别/角度/运镜要有节奏变化，并与剧情情绪匹配。
    4. content必须是纯画面描述，至少两句，覆盖环境与光线、主体动作链、关键细节与情绪线索；不得出现"特写"、"平视"、"推进"等技术词。
    5. 时长按剧情自然节奏单独计算，单镜头不超过10秒；不设固定区间或类型范围。
    6. 必须使用提供的角色名；不要自己创造新角色。
    7. 承接必写：非最后一镜的结尾需给出承接线索（目光停留、声音延续、动作落点），避免突然跳转。

    【合并与触发细化】
    - 合并：同一空间内的“观察→动作→细节→感受”属于连续动作链，优先合并为单镜；弱动作或物件细节吸收进相邻镜头；对话尽量与其声画线索同镜呈现。
    - 触发：仅当空间切换、时间跳转、信息或情绪显著转折时切镜；连续微动作用运镜表达而非切镜。

    【镜头数量约束】
    - 先在内部规划节拍数B（通常为5–8），遵循“一节拍一镜”的基准；仅当该节拍内部出现强烈情绪或信息转折时，最多拆为两镜。
    - 总镜头数不得超过B+1；若超过，按“连贯优先+同空间合并”原则重写并合并相邻镜头，直到满足该约束。
    - 禁止将同一场面的“观察/微动作/细节”分别拆成独立镜头；应在单镜content的多句中完整表达。
    - 注意力连续链不得拆分：当视线从A移到B且空间不变时，A与B应在同一镜的content中用两句描述，而不是切镜。
    - 相邻两镜若满足“同空间+同角色组合+承接类型相同（如视线/声音/动作/光线/温度）”，必须尝试合并为一镜并重写content与时长，除非存在显著信息或情绪转折。
    ```
*   **User Prompt**: `请根据以下剧本拆分分镜:\n\n${script}`

### 6.3 角色绘图 (Visual Artist Agent)
*   **System Prompt (Code: `src/utils/imageGeneration.js`)**:
    ```text
    你是专业的角色设计师,擅长创作一致的角色形象。
    ```
*   **Prompt构建逻辑 (Code: `buildCharacterPrompt`)**:
    ```text
    生成角色参考图: {name}, {nationality}, {gender}, {age}

    【外观特征】
    {desc (已过滤性格/背景等非视觉词汇)}

    【参考特征】 (仅当desc为空时)
    {traits}

    【整体风格】
    - 写实摄影
    - 电影级色彩分级
    - 35mm 定焦, f/2.8
    - 自然光照, 柔和阴影
    - 低噪点, 真实质感
    【避免】
    - 卡通，漫画，水彩，插画风，3D 渲染，夸张风格

    【生成要求】
    - 角度: 正面或3/4侧面肖像
    - 重点: 清晰的面部特征和整体形象
    - 背景: 简洁纯色或虚化背景
    - 只生成一个人物肖像
    ```

### 6.4 分镜绘图 (Visual Artist Agent)
*   **System Prompt (Code: `src/utils/imageGeneration.js`)**:
    ```text
    你是专业的分镜画师。目标：同一场景内的所有镜头环境（包含连续、穿插、回到、并行视角）保持一致，仅镜头参数与人物姿态可变。
    有参考图：严格对齐参考图的空间布局、主要物件、材质纹理、灯光类型与方向与色温、色彩分级、曝光与白平衡。
    无参考图：从分镜文字中提取环境锚点（地点、空间结构、主要物件、装饰、材质纹理、灯光、时间/天气、标识文字），在后续镜头中复用同一组锚点，位置与特征保持不变。
    一致性范围：
    1）空间结构与布局：墙/窗/门/吧台/货架等相对位置与尺度不变；
    2）场景物品与装饰：数量、位置、朝向、尺寸、状态（开/合、满/空）不变，除非分镜文字明确说明变化；
    3）标识与文字元素：招牌/海报/标签的内容、字体、颜色与位置不变；
    4）材质与纹理细节：地面/墙面/家具的材质、纹理、磨损/污渍/反射特征不变；
    5）光照与阴影：灯光类型与方向、色温与强度、阴影硬度与反射/高光不变；
    6）色彩分级与氛围：整体色彩分级、白平衡、对比度与颗粒/噪点风格不变；
    7）时间与天气：未在文字中说明变化视为不变；不得切换地点。
    允许变化：景别、机位、运镜、构图、人物姿态与站位。
    词汇一致：对环境锚点使用同一组词，不引入同义词或新名词。
    冲突处理：以环境一致性为最高优先。
    ```
*   **Prompt构建逻辑 (Code: `buildStoryboardPrompt`)**:
    ```text
    你是专业的分镜画师。请生成分镜图片。

    【整体风格】
    {globalStyle preset}
    【避免】
    {negative prompts}

    【场景 {scene}】
    角色: {character}
    【角色外观】
    - {name}（{nationality}, {gender}, {age}）: {desc}
    景别: {shot}

    {content}

    【镜头设定】
    - 统一镜头参数与色调, 不改变风格
    - 构图稳定, 光照一致, 色彩分级一致
    ```

## 7. 多模型策略及成本

为了平衡效果与成本，系统采用混合模型策略（Model Routing）。
**注意：目前文本部分主要使用 Gemini 2.5 Flash，更高级推理将使用 Gemini 3 (最新一代模型)；图片生成主要使用 Gemini 2.5 Flash Image (NanoBanana) 和 GPT-4o。**

| 任务模块 | 推荐模型 (首选/备选) | 成本估算 (输入/输出) | 状态 |
| :--- | :--- | :--- | :--- |
| **逻辑/文本分析**<br>(角色提取、分镜拆解) | **Gemini 2.5 Flash** (当前)<br>Gemini 3 (进阶/规划) | **Gemini 2.5 Flash**: ~$0.075 / 1M tokens (In) <br> ~$0.30 / 1M tokens (Out)<br>**Gemini 3**: 待公布 (预计与 Gemini 1.5 Pro 相当或略高) | **已实现 (Flash)** |
| **图像生成**<br>(角色、分镜图) | **NanoBanana** (Gemini 2.5 Flash Image)<br>GPT-4o (DALL-E 3) | **NanoBanana**: $0.039 / image ($30 / 1M tokens)<br>**GPT-4o**: $0.04 / image (Standard) | **已实现 (NanoBanana)** |
| **视频生成**<br>(动态分镜) | **Kling (可灵)** / Runway Gen-3 | **Kling**: ~$0.10 - $0.20 / sec (估算)<br>**Runway**: ~$0.10 / sec (估算) | *暂定* |
| **语音合成**<br>(配音) | **EdgeTTS** (免费) / 11Labs | **EdgeTTS**: 免费<br>**11Labs**: ~$0.18 / 1k characters | *暂定* |
