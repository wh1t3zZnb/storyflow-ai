# 角色提取和图片生成优化说明

## 问题描述

用户反馈角色提取功能存在两个问题:
1. **角色提取不完整**: 只提取到名称和设定摘要,缺少年龄、性别、特征、背景故事等字段
2. **图片生成混乱**: 由于提示词使用了包含性格、背景的desc字段,导致生成的不是纯粹的角色肖像

## 优化方案

### 1. 优化角色提取提示词 (`src/utils/llm.js`)

**问题根源**: 
原提示词太简单,只说"提取角色",没有明确要求提取哪些字段:
```javascript
// ❌ 旧版本 - 太简单
const sys = '你是分镜助手。只返回JSON，不要解释。输出对象必须是{"roles": Character[]}，字段严格匹配；中文输出。'
```

**✅ 优化后**: 详细列出所有字段要求和示例
```javascript
const sys = `你是专业的剧本分析助手。从剧本中提取所有角色信息。

【输出格式】
只返回JSON对象，格式: {"roles": Character[]}

【Character对象字段】（所有字段都必须填写）
- name: string - 角色名称
- age: string - 年龄或年龄段(例如"25"、"30岁左右"、"中年")
- gender: string - 性别("男"、"女"或"其他")
- desc: string - 外观描述(发型、着装、体型等可视化特征，30-100字)
- traits: string - 性格特征标签(例如"冷酷,敏捷,果断")
- backstory: string - 背景故事(简要说明角色背景，20-50字)
- styleTags: string[] - 风格标签数组(例如["写实","黑色电影"])

【提取要求】
1. 从剧本中识别所有出现的角色
2. 根据剧本内容推断角色信息（年龄、性别、外貌等）
3. desc字段必须是外观描述，不要包含性格和背景
4. 如果剧本中某些信息不明确，根据上下文合理推断
5. styleTags根据剧本整体风格判断
6. 所有字段都不能为空，必须有内容

【示例】...
`
```

**关键改进**:
- ✅ 明确列出所有字段和数据类型
- ✅ 说明每个字段的内容要求
- ✅ **强调desc字段只能是外观描述,不能包含性格和背景**
- ✅ 提供完整示例
- ✅ 要求所有字段都必须填写

### 2. 优化图片生成提示词构建 (`src/utils/imageGeneration.js`)

**问题根源**:
原`buildCharacterPrompt`函数会把所有字段都放入提示词,包括性格特征(traits)和背景故事(backstory),导致:
```javascript
// ❌ 旧版本会生成这样的提示词
请生成角色参考图: 女主人
女, 30岁左右
故事叙述主导主角，一位在年轻时因意外失聪的公寓女主人...  // ← 包含故事背景
特征: 敏感,警觉,孤独  // ← 性格特征不是外观
```

这会让AI理解混乱,生成的可能是"场景图"而不是"角色肖像"。

**✅ 优化后**: 智能过滤,只使用外观描述
```javascript
function buildCharacterPrompt(character) {
  // 1. 基础信息: 名称 + 性别 + 年龄
  // 2. **重点**: 只使用desc字段,且智能过滤非视觉信息
  if (character.desc && character.desc.trim()) {
    const descText = character.desc.trim();
    // 检查是否包含明显的非视觉词汇
    const hasNonVisual = /性格|背景|经历|故事|心理|情感|独居|工作|职业/.test(descText);
    
    if (!hasNonVisual) {
      // desc是纯外观描述,直接使用
      parts.push('【外观特征】');
      parts.push(descText);
    } else {
      // desc混入了非视觉信息,提取外观部分
      const sentences = descText.split(/[,，。]/);
      const visualSentences = sentences.filter(s => {
        return s && !/性格|背景|经历|故事|心理|情感|独居|工作|职业/.test(s);
      });
      if (visualSentences.length > 0) {
        parts.push('【外观特征】');
        parts.push(visualSentences.join('，'));
      }
    }
  }
  
  // 3. traits作为补充(仅当desc为空时)
  // 4. 固定要求: 写实摄影、肖像、简洁背景
}
```

**现在生成的提示词**:
```
生成角色参考图: 女主人, 女, 30岁左右

【外观特征】
中等身高，黑色长发，穿着灰色毛衣和牛仔裤，气质疲惫

【生成要求】
- 风格: 写实摄影
- 角度: 正面或3/4侧面肖像
- 重点: 清晰的面部特征和整体形象
- 背景: 简洁纯色或虚化背景
- 只生成一个人物肖像
```

**关键改进**:
- ✅ **不包含backstory字段**
- ✅ **过滤desc中的非视觉词汇**(性格、背景、故事等)
- ✅ **traits不用于图片生成**(除非desc为空)
- ✅ **明确要求"只生成一个人物肖像"**

## 字段使用规则

| 字段 | LLM提取时 | 图片生成时 | 说明 |
|------|----------|----------|------|
| name | ✅ 必填 | ✅ 使用 | 角色名称 |
| age | ✅ 必填 | ✅ 使用 | 年龄/年龄段 |
| gender | ✅ 必填 | ✅ 使用 | 性别 |
| **desc** | ✅ 必填,**只能是外观** | ✅ **主要依据** | 发型、着装、体型等可视化特征 |
| traits | ✅ 必填 | ❌ 不使用 | 性格特征标签,非视觉信息 |
| backstory | ✅ 必填 | ❌ 不使用 | 背景故事,非视觉信息 |
| styleTags | ✅ 必填 | ❌ 不使用 | 风格标签,用于全局风格 |

## 测试方法

1. **测试角色提取**:
   - 进入"剧本"标签页
   - 点击"随机生成"获取测试剧本
   - 点击"智能拆分分镜"
   - 检查生成的角色是否包含所有字段

2. **测试图片生成**:
   - 点击角色卡片进入编辑
   - 查看各字段内容
   - 点击"生成预览图"
   - 验证生成的是否是纯粹的角色肖像(不是场景图)

## 预期效果

### ✅ 正确的角色提取结果
```json
{
  "name": "女主人",
  "age": "30岁左右",
  "gender": "女",
  "desc": "中等身高，黑色长发，穿着灰色毛衣和牛仔裤，气质疲惫",
  "traits": "敏感,警觉,孤独",
  "backstory": "独居公寓的都市女性，对周围环境保持警惕",
  "styleTags": ["写实", "悬疑"]
}
```

### ✅ 正确的图片生成
- 应该是: **一个人的肖像照片**,清晰的面部特征,符合外观描述
- 不应该是: 包含场景、道具、多个角色的画面

## 文件变更

1. `src/utils/llm.js` - 优化`extractRoles`函数的提示词
2. `src/utils/imageGeneration.js` - 优化`buildCharacterPrompt`函数

---

**日期**: 2025-11-22
**优化目标**: 确保角色提取完整,图片生成准确
